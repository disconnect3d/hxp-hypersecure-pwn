#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

#include <unistd.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>

#define CHECK(val, msg) do { \
    if ((val)) { \
        puts(msg); \
        exit(1); \
    } \
} while(0)

int main() {
    int self = open("/proc/self/exe", O_RDONLY);
    CHECK(self<0, "Failed to open /proc/self/exe");

    uint8_t vm_code[0x1000];
    lseek(self, -0x1000, SEEK_END);
    ssize_t n = read(self, vm_code, 0x1000);
    CHECK(n != 0x1000, "Failed to read 0x1000 VM code bytes");

    int fd = open("/dev/hypersecure", O_RDWR);
    CHECK(fd<0, "Failed to open /dev/hypersecure");

    ioctl(fd, /* cmd, unused */ 0, &vm_code);
}
